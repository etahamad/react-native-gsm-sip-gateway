name: Build Android App

on:
  push:
    branches:
      - "**"
  workflow_dispatch:  # Allow manual triggering

jobs:
  build_android:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Cache Node.js modules
        uses: actions/cache@v4
        with:
          path: |
            telon-gateway-app/node_modules
            ~/.npm
          key: ${{ runner.os }}-node-modules-${{ hashFiles('telon-gateway-app/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-modules-

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 12
          cache: 'npm'
          cache-dependency-path: telon-gateway-app/package-lock.json

      - name: Set up OpenJDK 8
        run: |
          sudo apt update
          sudo apt install -y openjdk-8-jdk
          sudo update-alternatives --set java /usr/lib/jvm/java-8-openjdk-amd64/jre/bin/java
          java -version

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
      
      - name: Install Android SDK Components
        run: |
          yes | sdkmanager "platforms;android-19" "build-tools;25.2.5" "platform-tools"
        env:
          ANDROID_HOME: ${{ env.ANDROID_HOME }}
          ANDROID_SDK_ROOT: ${{ env.ANDROID_SDK_ROOT }}

      - name: Download NDK r17b
        run: |
          curl -o android-ndk-r17b-linux-x86_64.zip https://dl.google.com/android/repository/android-ndk-r17b-linux-x86_64.zip
          unzip -q android-ndk-r17b-linux-x86_64.zip -d $HOME/android-ndk
          rm android-ndk-r17b-linux-x86_64.zip

      - name: Set NDK path
        run: |
          echo "NDK_HOME=$HOME/android-ndk/android-ndk-r17b" >> $GITHUB_ENV
          echo "ANDROID_NDK_HOME=$HOME/android-ndk/android-ndk-r17b" >> $GITHUB_ENV
          echo "ndk.dir=$HOME/android-ndk/android-ndk-r17b" > telon-gateway-app/android/local.properties

      - name: Verify NDK installation
        run: |
          echo "NDK_HOME=$NDK_HOME"
          ls -la $NDK_HOME

      - name: Install Dependencies
        run: npm install
        working-directory: telon-gateway-app

      - name: Build React Native Bundle
        run: |
          mkdir -p android/app/build/intermediates/assets/release/
          npx react-native bundle --platform android --dev false --entry-file index.js --bundle-output android/app/build/intermediates/assets/release/index.android.bundle --assets-dest android/app/build/intermediates/res/merged/release
        working-directory: telon-gateway-app

      - name: Build Android Release APK
        run: |
          cd android
          chmod +x gradlew
          ./gradlew clean
          ./gradlew assembleRelease
        working-directory: telon-gateway-app
        env:
          ANDROID_HOME: ${{ env.ANDROID_HOME }}
          ANDROID_NDK_HOME: ${{ env.ANDROID_NDK_HOME }}

      - name: Build Android Release AAB (optional)
        run: |
          cd android
          ./gradlew bundleRelease
        working-directory: telon-gateway-app
        continue-on-error: true  # Don't fail if AAB build fails
        env:
          ANDROID_HOME: ${{ env.ANDROID_HOME }}
          ANDROID_NDK_HOME: ${{ env.ANDROID_NDK_HOME }}

      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: telon-gateway-app/android/app/build/outputs/apk/release/*.apk
          retention-days: 30

      - name: Upload AAB Artifact (if available)
        uses: actions/upload-artifact@v4
        if: success() || failure()  # Upload even if previous step failed
        with:
          name: android-aab
          path: telon-gateway-app/android/app/build/outputs/bundle/release/*.aab
          retention-days: 30
          if-no-files-found: ignore
